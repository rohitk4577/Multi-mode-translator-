<!DOCTYPE html>
<html lang="en" class="dark"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Mode AI Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Set theme from localStorage or system preference
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'neon-purple': '#1a052a',
                        'neon-magenta': '#ff00ff',
                        'neon-cyan': '#00ffff',
                        'light-lavender': '#f0e6ff',
                        'dark-card': '#2a0d45',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f8ff; /* AliceBlue */
            color: #333;
            transition: background 0.3s, color 0.3s;
        }
        .dark body {
            background-color: #1a052a; /* neon-purple */
            color: #f0e6ff; /* light-lavender */
        }
        .dark .text-gray-900 { color: #f0e6ff !important; }
        .dark .text-gray-500 { color: #a799b7 !important; }
        .dark .hover\:bg-gray-700:hover { background-color: #2a0d45 !important; }


        .translator-card {
            background-color: #ffffff;
            border: 1px solid #e0e8f0;
            border-radius: 1rem;
        }
        .dark .translator-card {
            background-color: #2a0d45; /* dark-card */
            border: 1px solid #ff00ff; /* neon-magenta */
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
        }

        textarea {
            background-color: #f8faff;
            color: #333;
            border: 1px solid #d8e0e7;
            border-radius: 0.75rem;
        }
        .dark textarea {
            background-color: #1a052a; /* neon-purple */
            color: #f0e6ff;
            border: 1px solid #00ffff; /* neon-cyan */
        }
        textarea:focus {
            outline: none;
            border-color: #8a2be2; /* BlueViolet */
            box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.25);
        }
        .dark textarea:focus {
            border-color: #ff00ff; /* neon-magenta */
            box-shadow: 0 0 0 2px rgba(255, 0, 255, 0.5);
        }

        select {
            background-color: #f0f5ff;
            color: #333;
            border: 1px solid #d8e0e7;
            border-radius: 0.5rem;
        }
        .dark select {
            background-color: #2a0d45;
            color: #f0e6ff;
            border: 1px solid #00ffff;
        }
        select:focus {
            outline: none;
            border-color: #8a2be2;
        }
        .dark select:focus {
            border-color: #ff00ff;
        }

        .icon-btn {
            color: #8a2be2;
            background: #e9e9ff;
            border-radius: 0.5rem;
        }
        .dark .icon-btn {
            color: #00ffff;
            background: transparent;
        }
        .icon-btn:hover {
            background: #dcd6ff;
            color: #5d1c9c;
        }
        .dark .icon-btn:hover {
            background: #2a0d45;
            color: #ff00ff;
            text-shadow: 0 0 5px #ff00ff;
        }

        .swap-btn {
            background: #8a2be2;
            color: #fff;
            border: 4px solid #fff;
        }
        .dark .swap-btn {
            background: #ff00ff;
            color: #fff;
            border: 4px solid #2a0d45;
            box-shadow: 0 0 10px #ff00ff;
        }
        .swap-btn:hover {
            background: #7324bc;
        }
        .dark .swap-btn:hover {
            background: #e600e6;
            box-shadow: 0 0 15px #ff00ff;
        }

        .translate-btn {
            background: #8a2be2;
            color: #fff;
            padding: 10px 20px;
            border-radius: 0.5rem;
        }
        .dark .translate-btn {
            background: transparent;
            border: 2px solid #ff00ff;
            color: #ff00ff;
            text-shadow: 0 0 5px #ff00ff;
        }
        .translate-btn:hover {
            background: #7324bc;
        }
        .dark .translate-btn:hover {
            background: #ff00ff;
            color: #fff;
            text-shadow: none;
            box-shadow: 0 0 10px #ff00ff;
        }

        .char-counter {
            color: #6c757d;
        }
        .dark .char-counter {
            color: #00ffff;
        }

        .tab-btn {
            background: #f0f5ff;
            color: #333;
        }
        .dark .tab-btn {
            background: transparent;
            color: #00ffff;
        }
        .tab-btn.active {
            background: #8a2be2;
            color: #fff;
        }
        .dark .tab-btn.active {
            background: #ff00ff;
            color: #fff;
            border: 1px solid #ff00ff;
            box-shadow: 0 0 10px #ff00ff;
            text-shadow: none;
        }
        .tab-btn:not(.active):hover {
            background: #e9e9ff;
        }
        .dark .tab-btn:not(.active):hover {
            background: #2a0d45;
            color: #ff00ff;
        }
        .dark #tabs {
            background: transparent !important;
        }

        .loader {
            border: 4px solid #e9e9ff;
            border-top: 4px solid #8a2be2;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .dark .loader {
            border: 4px solid #2a0d45;
            border-top: 4px solid #ff00ff;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .morse-tap-btn {
            padding: 10px 20px;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            user-select: none; /* Prevent text selection on rapid clicks */
        }
        .morse-tap-btn:active {
            transform: scale(0.95);
        }
        /* Light mode */
        .morse-tap-btn {
            background: #e9e9ff;
            color: #8a2be2;
        }
        .morse-tap-btn:hover {
            background: #dcd6ff;
            border-color: #8a2be2;
        }
        /* Dark mode */
        .dark .morse-tap-btn {
            background: #2a0d45;
            color: #00ffff;
        }
        .dark .morse-tap-btn:hover {
            background: #1a052a;
            border-color: #ff00ff;
            box-shadow: 0 0 5px #ff00ff;
        }
        .main-footer {
            padding: 20px 0;
            text-align: center;
            font-size: 0.9rem;
            color: #6c757d;
        }
        .dark .main-footer {
            color: #a799b7;
        }
        .main-footer a {
            color: #8a2be2;
            text-decoration: none;
        }
        .dark .main-footer a {
            color: #00ffff;
        }
        .credits {
            font-size: 0.75rem;
            opacity: 0.6;
        }
    </style>
</head>
<body>

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <header class="text-center mb-6 relative w-full max-w-4xl">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white">Multi-Mode Translator</h1>
            <p class="text-lg text-gray-500 dark:text-gray-400 mt-2">Translate languages, Morse code, and more.</p>
            <p id="datetime" class="text-sm text-gray-500 dark:text-cyan-400 mt-2"></p>
            <div class="absolute top-0 right-0 flex items-center space-x-2">
                <button id="history-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200" title="Translation History">
                    <i data-lucide="history"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200" title="Toggle theme">
                    <i data-lucide="moon" class="hidden dark:block"></i>
                    <i data-lucide="sun" class="block dark:hidden"></i>
                </button>
            </div>
        </header>
        
        <main class="w-full max-w-5xl mx-auto">
            <div class="translator-card shadow-lg p-6 sm:p-8 min-h-[500px] flex flex-col">
                <nav id="tabs" class="flex justify-center items-center p-1 mb-4 bg-gray-100 dark:bg-gray-900 rounded-xl space-x-1">
                    <button data-tab="language" class="tab-btn active w-1/3 py-2">Language</button>
                    <button data-tab="eng-to-morse" class="tab-btn w-1/3 py-2">English to Morse</button>
                    <button data-tab="morse-to-eng" class="tab-btn w-1/3 py-2">Morse to English</button>
                </nav>

                <div id="language-translator" class="tab-content flex-grow">
                     <div class="relative grid grid-cols-1 md:grid-cols-2 gap-8 h-full items-stretch">
                        <div class="flex flex-col gap-3">
                            <select id="source-lang" class="p-2 w-full sm:w-auto self-start"></select>
                            <div class="relative flex-grow flex flex-col">
                                <textarea id="source-text" class="w-full flex-grow p-3 text-lg resize-none" placeholder="Enter text..."></textarea>
                                <div class="char-counter absolute bottom-2 right-3"><span id="char-count">0</span> / 5000</div>
                                <div class="absolute top-3 right-3 flex items-center space-x-2">
                                    <input type="file" id="file-input-lang" class="hidden" accept=".txt">
                                    <button class="icon-btn p-2" id="upload-btn-lang" title="Upload .txt File"><i data-lucide="file-up"></i></button>
                                    <button class="icon-btn p-2" id="mic-btn" title="Use Microphone"><i data-lucide="mic"></i></button>
                                    <button class="icon-btn p-2" id="paste-btn" title="Paste"><i data-lucide="clipboard-paste"></i></button>
                                    <button class="icon-btn p-2" id="clear-btn" title="Clear"><i data-lucide="x"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-10">
                            <button id="swap-btn" class="swap-btn p-3 rounded-full shadow-lg"><i data-lucide="repeat"></i></button>
                        </div>
                        
                        <div class="flex flex-col gap-3">
                            <select id="target-lang" class="p-2 w-full sm:w-auto self-start"></select>
                            <div id="output-container" class="relative flex-grow flex flex-col">
                                <textarea id="target-text" class="w-full flex-grow p-3 text-lg resize-none" placeholder="Translation" readonly></textarea>
                                <div class="absolute top-3 right-3 flex items-center space-x-2">
                                    <button class="icon-btn p-2" id="copy-btn" title="Copy"><i data-lucide="copy"></i></button>
                                    <button class="icon-btn p-2" id="speak-btn" title="Listen"><i data-lucide="volume-2"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="eng-to-morse-translator" class="hidden tab-content flex-grow">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                        <div class="flex flex-col gap-3">
                            <h3 class="font-semibold text-lg">English</h3>
                            <div class="relative flex-grow flex flex-col">
                                <textarea id="eng-input" class="w-full flex-grow p-3 text-lg resize-none" placeholder="Enter English text..."></textarea>
                                <div class="absolute top-3 right-3 flex items-center space-x-2">
                                    <input type="file" id="file-input-morse" class="hidden" accept=".txt">
                                    <button class="icon-btn p-2" id="upload-btn-morse" title="Upload .txt File"><i data-lucide="file-up"></i></button>
                                    <button class="icon-btn p-2" id="speak-eng-input-btn" title="Listen"><i data-lucide="volume-2"></i></button>
                                    <button class="icon-btn p-2" id="mic-btn-morse" title="Use Microphone"><i data-lucide="mic"></i></button>
                                    <button class="icon-btn p-2" id="paste-btn-morse" title="Paste"><i data-lucide="clipboard-paste"></i></button>
                                    <button class="icon-btn p-2" id="clear-btn-morse" title="Clear"><i data-lucide="x"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-3">
                            <h3 class="font-semibold text-lg">Morse Code</h3>
                            <div class="relative flex-grow flex flex-col">
                                <textarea id="morse-output" class="w-full flex-grow p-3 text-lg resize-none" placeholder="--- .-. ... . / -.-. --- -.. ." readonly></textarea>
                                <div class="absolute top-3 right-3 flex items-center space-x-2">
                                    <button class="icon-btn p-2" id="copy-morse-btn" title="Copy Morse"><i data-lucide="copy"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="morse-to-eng-translator" class="hidden tab-content flex-grow">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                        <div class="flex flex-col gap-3">
                            <h3 class="font-semibold text-lg">Morse Code</h3>
                            <div id="morse-tap-pad" class="p-4 bg-gray-100 dark:bg-gray-900 rounded-lg flex justify-center items-center gap-2">
                                <button id="tap-dot" class="morse-tap-btn">.</button>
                                <button id="tap-dash" class="morse-tap-btn">-</button>
                                <button id="tap-space" class="morse-tap-btn text-base">Space</button>
                                <button id="tap-backspace" class="morse-tap-btn text-base" title="Backspace"><i data-lucide="delete"></i></button>
                            </div>
                            <textarea id="morse-input" class="w-full flex-grow p-3 text-lg resize-none" placeholder="Tap or type Morse Code..."></textarea>
                        </div>
                        <div class="flex flex-col gap-3">
                            <h3 class="font-semibold text-lg">English</h3>
                            <div class="relative flex-grow flex flex-col">
                                <textarea id="eng-output" class="w-full flex-grow p-3 text-lg resize-none" placeholder="English text" readonly></textarea>
                                 <div class="absolute top-3 right-3 flex items-center space-x-2">
                                        <button class="icon-btn p-2" id="copy-eng-btn" title="Copy English"><i data-lucide="copy"></i></button>
                                        <button class="icon-btn p-2" id="speak-eng-btn" title="Listen"><i data-lucide="volume-2"></i></button>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button id="translate-btn" class="translate-btn text-lg w-full md:w-auto">
                       <i data-lucide="languages" class="inline-block -mt-1 mr-2"></i>
                       <span id="translate-btn-text">Translate</span>
                    </button>
                </div>
            </div>
            <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>
        </main>
        
        <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
            <div class="translator-card w-full max-w-2xl max-h-[80vh] flex flex-col p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Translation History</h2>
                    <button id="close-history-btn" class="icon-btn p-2"><i data-lucide="x"></i></button>
                </div>
                <div id="history-content" class="overflow-y-auto space-y-4 pr-4">
                    </div>
            </div>
        </div>

        <footer class="main-footer">
            <p>
                For support, contact our <strong>Customer Care</strong> at <a href="mailto:support@multimodetranslator.com">support@multimodetranslator.com</a>
                <br>
                <span class="credits">By Rohit, Leno & Rahul (RLR)</span>
            </p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // --- Date and Time ---
            const datetimeElement = document.getElementById('datetime');
            function updateDateTime() {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                if (datetimeElement) {
                    datetimeElement.textContent = now.toLocaleDateString(undefined, options);
                }
            }
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // --- State and Constants ---
            let activeTab = 'language';
            const BACKEND_URL = 'http://127.0.0.1:5000'; // URL of your Flask server

            // --- Element Selectors ---
            const elements = {
                themeToggle: document.getElementById('theme-toggle'),
                tabsContainer: document.getElementById('tabs'),
                translateBtn: document.getElementById('translate-btn'),
                translateBtnText: document.getElementById('translate-btn-text'),
                toast: document.getElementById('toast'),
                
                // Language Translator
                sourceLang: document.getElementById('source-lang'),
                targetLang: document.getElementById('target-lang'),
                sourceText: document.getElementById('source-text'),
                targetText: document.getElementById('target-text'),
                swapBtn: document.getElementById('swap-btn'),
                charCount: document.getElementById('char-count'),
                pasteBtn: document.getElementById('paste-btn'),
                clearBtn: document.getElementById('clear-btn'),
                copyBtn: document.getElementById('copy-btn'),
                speakBtn: document.getElementById('speak-btn'),
                micBtn: document.getElementById('mic-btn'),
                outputContainer: document.getElementById('output-container'),
                fileInputLang: document.getElementById('file-input-lang'),
                uploadBtnLang: document.getElementById('upload-btn-lang'),
                
                // Morse Translators
                engInput: document.getElementById('eng-input'),
                micBtnMorse: document.getElementById('mic-btn-morse'),
                pasteBtnMorse: document.getElementById('paste-btn-morse'),
                clearBtnMorse: document.getElementById('clear-btn-morse'),
                speakEngInputBtn: document.getElementById('speak-eng-input-btn'),
                morseOutput: document.getElementById('morse-output'),
                morseInput: document.getElementById('morse-input'),
                engOutput: document.getElementById('eng-output'),
                copyMorseBtn: document.getElementById('copy-morse-btn'),
                playMorseBtn: document.getElementById('play-morse-btn'),
                copyEngBtn: document.getElementById('copy-eng-btn'),
                speakEngBtn: document.getElementById('speak-eng-btn'),
                fileInputMorse: document.getElementById('file-input-morse'),
                uploadBtnMorse: document.getElementById('upload-btn-morse'),
                
                // History Modal
                historyBtn: document.getElementById('history-btn'),
                historyModal: document.getElementById('history-modal'),
                closeHistoryBtn: document.getElementById('close-history-btn'),
                historyContent: document.getElementById('history-content'),
            };

            // --- Theme Manager ---
            elements.themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                lucide.createIcons();
            });

            // --- Tab Manager ---
            function setActiveTab(tabName) {
                if (!tabName || tabName === activeTab) return;
                activeTab = tabName;
                elements.tabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('hidden', content.id !== `${tabName}-translator`));
                elements.translateBtnText.textContent = tabName === 'language' ? 'Translate' : 'Convert';
            }

            elements.tabsContainer.addEventListener('click', (e) => {
                const targetButton = e.target.closest('button');
                if (targetButton) setActiveTab(targetButton.dataset.tab);
            });

            const urlParams = new URLSearchParams(window.location.search);
            const initialTab = urlParams.get('tab');
            if (initialTab) setActiveTab(initialTab);

            // --- Utility Functions ---
            function showToast(message, isError = false) {
                elements.toast.textContent = message;
                elements.toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                elements.toast.classList.remove('opacity-0');
                setTimeout(() => elements.toast.classList.add('opacity-0'), 3000);
            }

            function showLoading(isLoading) {
                 const container = elements.outputContainer;
                 let loader = container.querySelector('.loader');
                 if (isLoading) {
                    if (!loader) {
                        loader = document.createElement('div');
                        loader.className = 'loader absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2';
                        container.appendChild(loader);
                    }
                    elements.targetText.value = '';
                    elements.targetText.placeholder = "Translating...";
                } else {
                    if (loader) loader.remove();
                    elements.targetText.placeholder = "Translation";
                }
            }
            
            async function copyToClipboard(text, successMessage) {
                 if (!text) return;
                 try {
                    await navigator.clipboard.writeText(text);
                    showToast(successMessage);
                 } catch (err) {
                     showToast('Failed to copy!', true);
                 }
            }

            // --- Language Translator Logic ---
            const languages = {'en': 'English', 'ta': 'Tamil', 'te': 'Telugu', 'hi': 'Hindi', 'es': 'Spanish', 'fr': 'French', 'de': 'German', 'it': 'Italian', 'pt': 'Portuguese', 'ru': 'Russian', 'ja': 'Japanese', 'ko': 'Korean', 'zh-CN': 'Chinese (Simplified)', 'ar': 'Arabic', 'bn': 'Bengali', 'gu': 'Gujarati', 'kn': 'Kannada', 'ml': 'Malayalam', 'mr': 'Marathi', 'pa': 'Punjabi', 'ur': 'Urdu'};
            
            Object.entries(languages).forEach(([code, name]) => {
                elements.sourceLang.add(new Option(name, code));
                elements.targetLang.add(new Option(name, code));
            });
            elements.sourceLang.value = 'en';
            elements.targetLang.value = 'es';

            elements.sourceText.addEventListener('input', () => {
                const count = elements.sourceText.value.length;
                elements.charCount.textContent = count;
                elements.charCount.classList.toggle('text-red-500', count > 5000);
            });

            elements.swapBtn.addEventListener('click', () => {
                [elements.sourceLang.value, elements.targetLang.value] = [elements.targetLang.value, elements.sourceLang.value];
                [elements.sourceText.value, elements.targetText.value] = [elements.targetText.value, elements.sourceText.value];
                elements.sourceText.dispatchEvent(new Event('input'));
            });

            elements.clearBtn.addEventListener('click', () => {
                elements.sourceText.value = '';
                elements.targetText.value = '';
                elements.sourceText.dispatchEvent(new Event('input'));
            });

            elements.pasteBtn.addEventListener('click', async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    elements.sourceText.value = text;
                    elements.sourceText.dispatchEvent(new Event('input'));
                } catch (err) {
                    showToast('Failed to paste from clipboard.', true);
                }
            });
            
            elements.copyBtn.addEventListener('click', () => copyToClipboard(elements.targetText.value, 'Copied to clipboard!'));
            
            function speakText(text, lang = 'en-US') {
                if (text && 'speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = lang;
                    speechSynthesis.speak(utterance);
                }
            }

            elements.speakBtn.addEventListener('click', () => speakText(elements.targetText.value, elements.targetLang.value));
            
             // --- File Upload Logic ---
             function handleFileUpload(file, targetTextArea, isMorse = false) {
                if (!file) return;

                if (file.type !== 'text/plain') {
                    showToast('Please upload a valid .txt file.', true);
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    if (text.length > 5000) {
                        showToast('File content exceeds 5000 character limit.', true);
                        return;
                    }

                    if (isMorse) {
                        try {
                            const response = await fetch(`${BACKEND_URL}/detect-language`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ text: text })
                            });
                            const data = await response.json();
                            if (data.language && data.language.toLowerCase().trim() !== 'english') {
                                showToast('Error: Only English text files can be converted to Morse code.', true);
                                return;
                            }
                        } catch (err) {
                             showToast('Could not verify file language.', true);
                             return;
                        }
                    }

                    targetTextArea.value = text;
                    targetTextArea.dispatchEvent(new Event('input'));
                };
                reader.onerror = () => showToast('Error reading file.', true);
                reader.readAsText(file);
            }

            elements.uploadBtnLang.addEventListener('click', () => elements.fileInputLang.click());
            elements.fileInputLang.addEventListener('change', (e) => {
                handleFileUpload(e.target.files[0], elements.sourceText, false);
                e.target.value = null; // Reset file input
            });

            elements.uploadBtnMorse.addEventListener('click', () => elements.fileInputMorse.click());
            elements.fileInputMorse.addEventListener('change', (e) => {
                handleFileUpload(e.target.files[0], elements.engInput, true);
                e.target.value = null; // Reset file input
            });
            
            // --- Speech Recognition Logic ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;

                elements.micBtn.addEventListener('click', () => {
                    recognition.lang = elements.sourceLang.value;
                    recognition.start();
                });

                recognition.onresult = (event) => {
                    elements.sourceText.value = Array.from(event.results).map(r => r[0].transcript).join('');
                };
                recognition.onerror = (event) => showToast(`Speech recognition error: ${event.error}`, true);

                const recognitionMorse = new SpeechRecognition();
                recognitionMorse.lang = 'en-US';
                recognitionMorse.continuous = false;
                recognitionMorse.interimResults = true;

                elements.micBtnMorse.addEventListener('click', () => recognitionMorse.start());

                recognitionMorse.onresult = (event) => {
                    elements.engInput.value = Array.from(event.results).map(r => r[0].transcript).join('');
                    translateToMorse();
                };
                recognitionMorse.onerror = (event) => showToast(`Speech recognition error: ${event.error}`, true);
            } else {
                [elements.micBtn, elements.micBtnMorse].forEach(btn => btn.style.display = 'none');
                showToast("Speech recognition not supported in this browser.", true);
            }

            // --- Morse Code Translator Logic ---
            async function translateToMorse() {
                const response = await fetch(`${BACKEND_URL}/eng-to-morse`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: elements.engInput.value })
                });
                const data = await response.json();
                elements.morseOutput.value = data.morse_code;
            }

            async function translateFromMorse() {
                const response = await fetch(`${BACKEND_URL}/morse-to-eng`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ morse_code: elements.morseInput.value })
                });
                const data = await response.json();
                elements.engOutput.value = data.english_text;
            }

            elements.engInput.addEventListener('input', translateToMorse);
            elements.morseInput.addEventListener('input', translateFromMorse);
            elements.clearBtnMorse.addEventListener('click', () => {
                elements.engInput.value = '';
                elements.morseOutput.value = '';
            });

            elements.pasteBtnMorse.addEventListener('click', async () => {
                try {
                    elements.engInput.value = await navigator.clipboard.readText();
                    translateToMorse();
                } catch (err) {
                    showToast('Failed to paste from clipboard.', true);
                }
            });

            elements.copyMorseBtn.addEventListener('click', () => copyToClipboard(elements.morseOutput.value, 'Morse code copied!'));
            elements.copyEngBtn.addEventListener('click', () => copyToClipboard(elements.engOutput.value, 'English text copied!'));
            elements.speakEngInputBtn.addEventListener('click', () => speakText(elements.engInput.value));
            elements.speakEngBtn.addEventListener('click', () => speakText(elements.engOutput.value));

            // --- Morse Tap Pad Logic ---
            document.getElementById('tap-dot').addEventListener('click', () => { elements.morseInput.value += '.'; translateFromMorse(); });
            document.getElementById('tap-dash').addEventListener('click', () => { elements.morseInput.value += '-'; translateFromMorse(); });
            document.getElementById('tap-space').addEventListener('click', () => {
                elements.morseInput.value += elements.morseInput.value.endsWith(' ') ? '/ ' : ' ';
                translateFromMorse();
            });
            document.getElementById('tap-backspace').addEventListener('click', () => {
                elements.morseInput.value = elements.morseInput.value.slice(0, -1);
                translateFromMorse();
            });

            // --- Main Translate/Convert Logic ---
            elements.translateBtn.addEventListener('click', async () => {
                if (activeTab === 'language') {
                    await handleLanguageTranslation();
                }
            });

            async function handleLanguageTranslation() {
                const text = elements.sourceText.value.trim();
                if (!text || text.length > 5000) {
                    showToast(text ? 'Text exceeds 5000 character limit.' : 'Please enter text to translate.', true);
                    return;
                }
                
                showLoading(true);
                try {
                    const response = await callBackendApi(text, languages[elements.sourceLang.value], languages[elements.targetLang.value]);
                    elements.targetText.value = response.translated_text;
                } catch (error) {
                    elements.targetText.value = "Error: Could not translate.";
                    showToast('An error occurred during translation.', true);
                } finally {
                    showLoading(false);
                }
            }

            // --- Backend API Call ---
            async function callBackendApi(text, sourceLangName, targetLangName) {
                const response = await fetch(`${BACKEND_URL}/translate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        source_lang: sourceLangName,
                        target_lang: targetLangName
                    })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                return result;
            }

            // --- History Modal Logic ---
            elements.historyBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/results/`);
                    const results = await response.json();
                    
                    elements.historyContent.innerHTML = '';

                    if (results.data && results.data.length > 0) {
                        results.data.slice().reverse().forEach(item => {
                            if (item.translated_text) {
                                const historyItem = document.createElement('div');
                                historyItem.className = 'p-4 rounded-lg border border-cyan-500/50 bg-neon-purple/50';
                                historyItem.innerHTML = `
                                    <p class="text-sm text-gray-400">${new Date(item.timestamp).toLocaleString()}</p>
                                    <p class="mt-2"><span class="font-semibold text-cyan-400">From ${item.source_lang || 'N/A'}:</span></p>
                                    <p class="font-mono p-2 bg-black/20 rounded mt-1 break-words">${item.original_text || '...'}</p>
                                    <p class="mt-2"><span class="font-semibold text-cyan-400">To ${item.target_lang || 'N/A'}:</span></p>
                                    <p class="font-mono p-2 bg-black/20 rounded mt-1 break-words">${item.translated_text}</p>
                                `;
                                elements.historyContent.appendChild(historyItem);
                            }
                        });
                    } else {
                        elements.historyContent.innerHTML = '<p class="text-gray-400">No translation history found.</p>';
                    }
                    elements.historyModal.classList.remove('hidden');
                } catch (error) {
                    console.error("History fetch error:", error);
                    showToast('Could not fetch history.', true);
                }
            });

            elements.closeHistoryBtn.addEventListener('click', () => {
                elements.historyModal.classList.add('hidden');
            });

            // --- Morse Sound Playback ---
            function playMorseCode(morseCode) {
                if (!morseCode || !(window.AudioContext || window.webkitAudioContext)) {
                    if (morseCode) showToast("Web Audio API not supported in this browser.", true);
                    return;
                }
                
                const context = new (window.AudioContext || window.webkitAudioContext)();
                let time = context.currentTime;
                const dotDuration = 0.1;
                const dashDuration = dotDuration * 3;
                const symbolGap = dotDuration;
                const letterGap = dotDuration * 3;
                const wordGap = dotDuration * 7;

                for (const char of morseCode) {
                    if (char === '.') {
                        const oscillator = context.createOscillator();
                        oscillator.frequency.value = 750;
                        oscillator.connect(context.destination);
                        oscillator.start(time);
                        oscillator.stop(time + dotDuration);
                        time += dotDuration + symbolGap;
                    } else if (char === '-') {
                        const oscillator = context.createOscillator();
                        oscillator.frequency.value = 750;
                        oscillator.connect(context.destination);
                        oscillator.start(time);
                        oscillator.stop(time + dashDuration);
                        time += dashDuration + symbolGap;
                    } else if (char === ' ') {
                        time += letterGap - symbolGap;
                    } else if (char === '/') {
                        time += wordGap - letterGap;
                    }
                }
            }
             elements.playMorseBtn.addEventListener('click', () => playMorseCode(elements.morseOutput.value));
        });
    </script>
</body>
</html>